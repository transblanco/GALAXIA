<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FFVV Transblanco J & M S.R.L ‚Äî Cierre KPI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#0b1020;
      --card:#0f1724;
      --muted:#9ca3af;
      --accent:#7c3aed;
      --accent-2:#06b6d4;
      --comisional:#10b981;
      --incentivos:#f97316;
      --orange:#f97316;
    }
    html,body { background: linear-gradient(180deg,#070712 0%, var(--bg) 100%); color:#e6eef8; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .glass { background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.015)); border: 1px solid rgba(255,255,255,0.04); backdrop-filter: blur(6px); }

    /* Fix for selects: make dropdown readable by using light background and dark text */
    select.filter-select { background: rgba(255,255,255,0.95); color: #0b1020; padding:8px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); }
    select.filter-select option { color:#0b1020; }

    .timeline { position: relative; padding: 2rem 0; }
    .timeline::before{ content:''; position:absolute; left:50%; transform:translateX(-50%); width:4px; height:100%; background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); border-radius: 4px; }
    .node { width:48px; height:48px; border-radius:999px; display:flex; align-items:center; justify-content:center; box-shadow: 0 6px 18px rgba(0,0,0,0.6); transition: transform .28s ease, box-shadow .28s ease; transform-origin:center center; }
    .kpi-card { width: calc(50% - 3.5rem); padding: .75rem 1rem; border-radius: 12px; box-shadow: 0 10px 25px rgba(2,6,23,0.6); transition: transform .35s, opacity .35s; transform-origin: left center; background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(0,0,0,0.02)); }
    .in-view { transform: scale(1.06); box-shadow: 0 12px 30px rgba(0,0,0,0.7); }
    .out-view { transform: scale(.88); opacity:.6; filter: blur(.1px); }
    .left-wrap { display:flex; justify-content:flex-end; gap:1rem; align-items:center; }
    .right-wrap { display:flex; justify-content:flex-start; gap:1rem; align-items:center; }
    @media (max-width:640px){ .kpi-card { width: calc(100% - 5rem); font-size: .95rem; } .timeline::before { left: 48px; transform:none; } .node { position: absolute; left: 24px; transform:none; } .left-wrap, .right-wrap { flex-direction: row; justify-content:flex-start; } }
    .reveal { transform: translateY(20px) scale(.96); opacity:0; transition: all .6s cubic-bezier(.2,.9,.25,1); }
    .reveal.show { transform: translateY(0) scale(1); opacity:1; }
    .logo-accent { background: linear-gradient(90deg,var(--accent),var(--accent-2)); -webkit-background-clip:text; background-clip:text; color:transparent; font-weight:700; }
    .badge-orange { color: #fff; background: var(--orange); padding:4px 8px; border-radius:999px; font-weight:600; font-size:.78rem; }
    .puntaje-high { font-weight:800; font-size:1.1rem; color:#fff; background: linear-gradient(90deg, rgba(124,58,237,0.12), rgba(6,182,212,0.06)); padding:6px 8px; border-radius:8px; display:inline-block; }
    .cierren-box { display:flex; gap:1rem; align-items:center; justify-content:space-between; padding:.6rem .8rem; border-radius:10px; background: linear-gradient(90deg, rgba(124,58,237,0.06), rgba(6,182,212,0.02)); border:1px solid rgba(124,58,237,0.08); }
    .lock-icon { font-size:14px; vertical-align:middle; margin-right:6px; }
  </style>
</head>
<body>
  <main class="max-w-xl mx-auto p-4">
    <header class="mb-4">
      <h1 class="text-xl font-semibold logo-accent">FFVV Transblanco J &amp; M S.R.L</h1>
      <p class="text-xs text-slate-400 mt-1">Cierre de KPI - Vendedores</p>
    </header>

    <!-- FILTERS -->
    <section class="mb-4 grid grid-cols-3 gap-3">
      <select id="filterYear" class="filter-select"></select>
      <select id="filterMonth" class="filter-select"></select>
      <select id="filterZone" class="filter-select"></select>
    </section>

    <!-- PROFILE / ZONE SUMMARY -->
    <section id="profile" class="glass p-3 rounded mb-4 flex items-center gap-3">
      <img id="sellerPhoto" src="https://via.placeholder.com/96" alt="vendedor" class="w-20 h-20 rounded-full object-cover ring-2 ring-white/10 shadow-sm" />
      <div class="flex-1">
        <div id="sellerName" class="text-lg font-semibold">Zona / Selector</div>
        <div id="sellerRole" class="text-sm text-slate-400 mt-1">Rol: --</div>
        <div class="text-xs text-slate-400 mt-2">Zona: <span id="sellerZone">--</span></div>
      </div>
      <div style="min-width:170px; text-align:right;">
        <div class="text-xs text-slate-400">CIERRE COMISIONAL:</div>
        <div id="cierreComisional" class="text-2xl font-extrabold text-white">0.00%</div>
      </div>
    </section>

    <!-- TIMELINE -->
    <section id="timelineWrap" class="timeline relative"></section>

    <footer class="mt-6 text-center text-xs text-slate-500">Filtra por a√±o, mes y zona para ver los KPIs aplicables.</footer>
  </main>

  <script>
    // helper: escape html
    function escapeHtml(s){ if(s===undefined||s===null) return ''; return String(s).replace(/[&<>"]+/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'})[m]); }

    function resolvePhotoPath(photoVal){ if(!photoVal) return 'https://via.placeholder.com/96'; const s = String(photoVal).trim(); if(/^https?:\/\//i.test(s) || /^\/\//.test(s)) return s; if(s.indexOf('/') !== -1) return s; return './img/' + s; }

    async function loadData(){
      try{
        const r = await fetch('./cierres.json', {cache:'no-store'});
        if(!r.ok) throw new Error('HTTP ' + r.status + ' al leer cierres.json');
        const j = await r.json();
        if(!j || !Array.isArray(j.cierres)) throw new Error('Formato inv√°lido: se espera {"cierres":[...]}');
        // Ensure year/month fields exist by extracting from mes if needed
        j.cierres.forEach(it=>{
          if((it.year === undefined || it.month === undefined) && it.mes){
            const mstr = String(it.mes);
            if(mstr.length >= 6){
              const y = mstr.substr(0,4); const mo = mstr.substr(4,2);
              if(!isNaN(Number(y))) it.year = Number(y);
              if(!isNaN(Number(mo))) it.month = Number(mo);
            }
          }
        });
        return j.cierres;
      } catch(e){ document.getElementById('timelineWrap').innerHTML = `<div class="text-center text-sm text-slate-400 py-8">Error leyendo cierres.json: ${escapeHtml(e.message)}</div>`; throw e; }
    }

    function toPercentDisplay(v){ if(v === null || v === undefined || v === '') return ''; const n = Number(v); if(isNaN(n)) return String(v); const val = (n > 0 && n <= 1) ? n * 100 : (n * 100); const rounded = Math.round(val * 100) / 100; return rounded + '%'; }
    function normalizeNumericForSum(v){ if(v === null || v === undefined || v === '') return NaN; const n = Number(v); if(isNaN(n)) return NaN; return (n > 0 && n <= 1) ? n * 100 : (n * 100); }

    function buildFilteredIndex(cierres, yearFilter, monthFilter, zoneFilter){
      const filtered = cierres.filter(it=>{
        if(zoneFilter && String(it.zona||'') !== String(zoneFilter)) return false;
        if(yearFilter && it.year !== undefined){ if(String(it.year) !== String(yearFilter)) return false; }
        if(monthFilter && it.month !== undefined){ if(Number(it.month) !== Number(monthFilter)) return false; }
        // if year/month absent but mes present, already extracted in loadData
        return true;
      });

      const zones = {};
      filtered.forEach(it=>{
        const zona = it.zona || 'SinZona';
        if(!zones[zona]) zones[zona] = {};
        const key = (it.nombre || 'SinNombre') + '||' + (it.tipo || '');
        if(!zones[zona][key]) zones[zona][key] = { nombre: it.nombre || 'SinNombre', tipo: it.tipo || '', foto: it.foto || '', zona: zona, records: [] };
        zones[zona][key].records.push(it);
      });

      const zonesArr = {};
      Object.keys(zones).forEach(z=> zonesArr[z] = Object.values(zones[z]));
      return { filtered, zones: zonesArr };
    }

    // Sum all puntajes in the filtered set (regardless of candado)
    function computeCierreComisional(records){
      let sum = 0;
      records.forEach(it=>{
        if(it.puntaje !== undefined && it.puntaje !== null && String(it.puntaje).trim() !== ''){
          const raw = Number(it.puntaje);
          if(!isNaN(raw)){
            const normalized = (raw > 0 && raw <= 1) ? raw * 100 : (raw * 100);
            if(!isNaN(normalized)) sum += normalized;
          }
        }
      });
      return Math.round(sum * 100) / 100; // two decimals
    }

    function createTimelineFromRecords(records){
      const specialOrder = ['ADHERENCIA DE PRECIO','MISIONES DE CREACI√ìN DE VALOR','MISIONES DE EJECUCI√ìN + DIGITALES'];
      const normal = [];
      const specialBuckets = { 'ADHERENCIA DE PRECIO':[], 'MISIONES DE CREACI√ìN DE VALOR':[], 'MISIONES DE EJECUCI√ìN + DIGITALES':[] };

      records.forEach(it=>{
        const title = (it.kpi || 'KPI').toString();
        const obj = {
          title: title,
          alcance: (it.alcance !== undefined) ? toPercentDisplay(it.alcance) : '',
          alcance_num: (it.alcance !== undefined) ? normalizeNumericForSum(it.alcance) : NaN,
          alcance_kpi: (it.alcance_kpi !== undefined) ? toPercentDisplay(it.alcance_kpi) : '',
          alcance_kpi_num: (it.alcance_kpi !== undefined) ? normalizeNumericForSum(it.alcance_kpi) : NaN,
          candado: it.candado || '',
          alcance_candado_num: (it.alcance_candado !== undefined) ? normalizeNumericForSum(it.alcance_candado) : NaN,
          meta_candado_num: (it.meta_candado !== undefined) ? normalizeNumericForSum(it.meta_candado) : NaN,
          cumplio_candado: (it.candado && !isNaN(Number(it.alcance_candado)) && !isNaN(Number(it.meta_candado))) ? (Number(it.alcance_candado) >= Number(it.meta_candado)) : null,
          puntaje_display: (it.puntaje !== undefined && it.puntaje !== null) ? toPercentDisplay(it.puntaje) : '',
          puntaje_num: (it.puntaje !== undefined && it.puntaje !== null) ? normalizeNumericForSum(it.puntaje) : NaN,
          raw: it
        };
        const titleUpper = title.toUpperCase().trim();
        if(specialOrder.indexOf(titleUpper) >= 0) specialBuckets[titleUpper].push(obj); else normal.push(obj);
      });
      const final = normal.slice(); specialOrder.forEach(k=>{ if(specialBuckets[k] && specialBuckets[k].length) final.push(...specialBuckets[k]); });
      return final;
    }

    function renderZoneUI(zoneName, sellersArray, allFilteredRecords){
      const wrap = document.getElementById('timelineWrap'); wrap.innerHTML = '';
      if(!sellersArray || sellersArray.length === 0){ wrap.innerHTML = `<div class="text-center text-sm text-slate-400 py-8">No hay datos para la combinaci√≥n seleccionada.</div>`; return; }

      const rep = sellersArray[0];
      document.getElementById('sellerPhoto').src = resolvePhotoPath(rep.foto);
      document.getElementById('sellerName').textContent = zoneName + ' ‚Äî ' + (rep.nombre || '');
      const hasVendedor = sellersArray.some(s => String(s.tipo || '').toLowerCase().indexOf('vendedor') >= 0);
      const role = hasVendedor ? 'EJECUTIVO COMERCIAL' : (sellersArray[0].tipo || '').toUpperCase() || '--';
      document.getElementById('sellerRole').textContent = 'Rol: ' + role;
      document.getElementById('sellerZone').textContent = zoneName;

      const cierre = computeCierreComisional(allFilteredRecords || []);
      document.getElementById('cierreComisional').textContent = (isNaN(cierre) ? '0.00%' : cierre.toFixed(2) + '%');

      sellersArray.forEach((seller, sIdx) => {
        const sellerHeader = document.createElement('div');
        sellerHeader.className = 'glass p-3 rounded mb-4';
        sellerHeader.innerHTML = `<div class="flex items-center justify-between"><div><div class="font-semibold">${escapeHtml(seller.nombre)}</div><div class="text-xs text-slate-400">${escapeHtml(seller.tipo || '')}</div></div><div class="text-sm text-slate-400">Zona: ${escapeHtml(seller.zona)}</div></div>`;
        wrap.appendChild(sellerHeader);

        const kpis = createTimelineFromRecords(seller.records);
        kpis.forEach((kpi, idx) => {
          const container = document.createElement('div'); container.className = 'mb-8 relative reveal'; container.style.zIndex = 10;
          const side = (idx % 2 === 0) ? 'left' : 'right'; const inner = document.createElement('div'); inner.className = side === 'left' ? 'left-wrap items-center' : 'right-wrap items-center';
          const card = document.createElement('div'); card.className = 'kpi-card glass';
          const upperTitle = kpi.title.toUpperCase().trim();
          let isOrange = (upperTitle === 'ADHERENCIA DE PRECIO' || upperTitle === 'MISIONES DE CREACI√ìN DE VALOR' || upperTitle === 'MISIONES DE EJECUCI√ìN + DIGITALES');
          if(isOrange) card.style.borderLeft = '4px solid var(--orange)'; else if(kpi.candado) card.style.borderLeft = '4px solid var(--incentivos)'; else card.style.borderLeft = '4px solid var(--comisional)';

          let innerHTML = `<div class="flex items-start gap-3"><div style="flex:1">`;
          innerHTML += `<div class="text-xs text-slate-400">${escapeHtml(kpi.title)}</div>`;
          innerHTML += `<div class="text-sm mt-1">ALCANCE: <strong>${escapeHtml(kpi.alcance || '')}</strong></div>`;
          innerHTML += `<div class="text-sm mt-1">ALCANCE-KPI: <strong>${escapeHtml(kpi.alcance_kpi || '')}</strong></div>`;
          if(kpi.candado){ const cumplio = (kpi.cumplio_candado === true) ? 'SI' : (kpi.cumplio_candado === false ? 'NO' : 'N/A'); const lockIcon = (kpi.cumplio_candado === true) ? 'üîì' : (kpi.cumplio_candado === false ? 'üîí' : 'üîê'); innerHTML += `<div class="text-sm mt-2">CANDADO: <span class="text-slate-100 font-medium">${escapeHtml(kpi.candado)}</span></div>`; innerHTML += `<div class="flex items-center text-sm mt-1"><span class="lock-icon">${lockIcon}</span>CUMPLI√ì: <strong style="margin-left:6px">${cumplio}</strong></div>`; }
          innerHTML += `<div class="mt-3">PUNTAJE: <span class="puntaje-high">${escapeHtml(kpi.puntaje_display || '')}</span></div>`;
          innerHTML += `</div></div>`; card.innerHTML = innerHTML;

          const node = document.createElement('div'); node.className = 'node glass'; node.innerHTML = `<div style="font-size:18px">${kpi.candado ? 'üîí' : '‚öë'}</div>`;
          if(isOrange) node.style.background = 'linear-gradient(90deg,var(--orange),rgba(249,115,22,.9))'; else if(kpi.candado) node.style.background = 'linear-gradient(90deg,var(--incentivos),rgba(249,115,22,.9))'; else node.style.background = 'linear-gradient(90deg,var(--comisional),rgba(16,185,129,.9))';

          if(window.innerWidth <= 640){ node.style.position = 'absolute'; node.style.left = '8px'; node.style.top = '0'; card.style.marginLeft = '3.5rem'; inner.appendChild(card); inner.appendChild(node); } else { if(side === 'left'){ inner.appendChild(card); inner.appendChild(node); } else { inner.appendChild(node); inner.appendChild(card); } }

          container.appendChild(inner); wrap.appendChild(container);
        });
      });
      initObservers();
    }

    function initObservers(){ const reveals = document.querySelectorAll('.reveal'); const options = { root:null, rootMargin:'0px', threshold:.15 }; const observer = new IntersectionObserver((entries)=>{ entries.forEach(ent=>{ if(ent.isIntersecting){ ent.target.classList.add('show'); const node = ent.target.querySelector('.node'); if(node) node.classList.add('in-view'); ent.target.classList.remove('out-view'); } else { ent.target.classList.remove('show'); const node = ent.target.querySelector('.node'); if(node) node.classList.remove('in-view'); ent.target.classList.add('out-view'); } }); }, options); reveals.forEach(r=>observer.observe(r)); }

    function populateFiltersFromData(cierres){
      const fy = document.getElementById('filterYear'); const fm = document.getElementById('filterMonth'); const fz = document.getElementById('filterZone'); fy.innerHTML = ''; fm.innerHTML = ''; fz.innerHTML = '';
      const years = new Set(); const months = new Set(); const zones = new Set();
      cierres.forEach(it=>{ if(it.year !== undefined) years.add(String(it.year)); else if(it.mes && String(it.mes).length >=6) years.add(String(String(it.mes).substr(0,4))); if(it.month !== undefined) months.add(Number(it.month)); else if(it.mes && String(it.mes).length >=6) months.add(Number(String(it.mes).substr(4,2))); if(it.zona) zones.add(it.zona); });
      Array.from(years).sort((a,b)=>b-a).forEach(y => { const o = document.createElement('option'); o.value = y; o.textContent = y; fy.appendChild(o); }); if(fy.options.length === 0){ const o = document.createElement('option'); o.value = new Date().getFullYear(); o.textContent = new Date().getFullYear(); fy.appendChild(o); }
      const monthNames = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Sept','Oct','Nov','Dic']; Array.from(months).sort((a,b)=>a-b).forEach(m => { const o = document.createElement('option'); o.value = m; o.textContent = monthNames[m-1] || m; fm.appendChild(o); }); if(fm.options.length === 0){ const o = document.createElement('option'); const mm = new Date().getMonth()+1; o.value = mm; o.textContent = monthNames[mm-1]; fm.appendChild(o); }
      Array.from(zones).sort().forEach(z => { const o = document.createElement('option'); o.value = z; o.textContent = z; fz.appendChild(o); }); if(fz.options.length === 0){ const o = document.createElement('option'); o.value = 'SinZona'; o.textContent = 'SinZona'; fz.appendChild(o); }
    }

    (async function init(){
      let cierres; try { cierres = await loadData(); } catch(e){ return; }
      populateFiltersFromData(cierres);
      const yearSel = document.getElementById('filterYear'); const monthSel = document.getElementById('filterMonth'); const zoneSel = document.getElementById('filterZone');
      function renderAll(){ const y = yearSel.value; const m = monthSel.value; const z = zoneSel.value; const idx = buildFilteredIndex(cierres, y, m, z); const sellersArray = idx.zones[z] || []; renderZoneUI(z, sellersArray, idx.filtered.filter(it=> String(it.zona||'') === String(z))); }
      yearSel.addEventListener('change', renderAll); monthSel.addEventListener('change', renderAll); zoneSel.addEventListener('change', renderAll);
      renderAll(); let to; window.addEventListener('resize', ()=>{ clearTimeout(to); to = setTimeout(()=>{ renderAll(); }, 220); });
    })();
  </script>
</body>
</html>
