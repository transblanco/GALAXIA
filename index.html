<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Galaxia KPI â€” Gestor</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --bg: #0f1724;
            --card: #0b1220;
            --muted: #9ca3af;
            --accent: #3b82f6;
            --accent-green: #10b981;
        }
        body { background: var(--bg); color: #e6eef8; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
        .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border: 1px solid rgba(255,255,255,0.04); }
        .tag { font-weight:600; font-size:.82rem; padding:.25rem .55rem; border-radius:9999px; color:#fff; display:inline-block; margin-right:6px; margin-bottom:4px; }
        .small-muted { color:var(--muted); font-size:.86rem; }
        .row-hover:hover { background: rgba(255,255,255,0.02); cursor:pointer; }
        .scroll-y { max-height:220px; overflow-y:auto; }
        .level-badge { display:inline-flex; align-items:center; gap:6px; padding:.25rem .5rem; border-radius:10px; font-size:.82rem; margin-right:6px; background: rgba(255,255,255,0.02); }
        .btn { transition: all .12s ease; }
        .btn:hover { transform: translateY(-1px); }
        /* Modal overlay with 95% opacity */
        .modal-overlay { background: rgba(0,0,0,0.95); position: absolute; inset: 0; }
        /* Make modal content slightly less transparent (solid) */
        .modal-card { background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01)); border: 1px solid rgba(255,255,255,0.04); }
        @media (max-width:820px){ .md\:grid-cols-2{ grid-template-columns: 1fr; } }
    </style>
</head>
<body class="min-h-screen">

    <script src="/GALAXIA/frontend-config.js"></script>
    <script src="/GALAXIA/app.js"></script>

    <div class="max-w-6xl mx-auto p-6">

        <header class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-2xl font-bold text-white">ğŸ“Š Galaxia KPI â€” Gestor</h1>
                <p class="small-muted mt-1">Seguimiento auditorÃ­a â€” Backus (Galaxia)</p>
            </div>

            <div class="flex items-center gap-3">
                <div id="adminBadge" class="hidden px-3 py-1 rounded-full bg-green-600 text-black font-semibold">ADMIN</div>
                <button id="loginBtn" class="px-3 py-2 rounded-md bg-indigo-600 hover:bg-indigo-500 btn">ğŸ”‘ Ingresar Admin</button>
                <button id="newTaskBtn" class="px-3 py-2 rounded-md bg-emerald-500 hover:bg-emerald-400 btn hidden">â• Nueva tarea</button>
            </div>
        </header>

        <div class="flex items-center justify-between gap-4 mb-6">
            <div class="flex items-center gap-3">
                <div class="card px-4 py-2 rounded-md small-muted">Tareas guardadas: <span id="countTasks" class="font-semibold text-white ml-2">0</span></div>
                <div class="card px-4 py-2 rounded-md small-muted">Ãreas: <span id="countAreas" class="font-semibold text-white ml-2">0</span></div>
            </div>
            <div class="small-muted">ConexiÃ³n: <span id="statusAdmin" class="font-semibold text-white ml-2">Usuario</span></div>
        </div>

        <section class="card rounded-lg p-4">
            <div id="taskTable" class="w-full overflow-x-auto"></div>
        </section>
    </div>

    <div id="createModal" class="fixed inset-0 hidden z-50 flex items-center justify-center">
        <div class="modal-overlay"></div>
        <div class="relative max-w-3xl w-full mx-4 modal-card rounded-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 id="createTitle" class="text-xl font-bold">â• Nueva tarea</h2>
                <button class="text-gray-300" onclick="closeCreateModal()">âœ•</button>
            </div>

            <form id="createForm" class="grid grid-cols-1 gap-3">
                <div class="grid grid-cols-3 gap-3">
                    <input id="inputItem" class="col-span-1 p-2 rounded bg-transparent border border-zinc-700" placeholder="Item (ej: 1.1.1)" required>
                    <input id="inputTitulo" class="col-span-2 p-2 rounded bg-transparent border border-zinc-700" placeholder="TÃ­tulo de la tarea" required>
                </div>

                <div class="grid grid-cols-3 gap-3">
                    <div class="col-span-1">
                        <label class="small-muted mb-1 block">Ãreas (Ctrl/Shift para mult)</label>
                        <select id="selectAreas" multiple class="w-full p-2 rounded bg-transparent border border-zinc-700"></select>
                    </div>
                    <div class="col-span-1 flex items-end gap-2">
                        <button type="button" class="px-3 py-2 bg-indigo-600 rounded btn" onclick="openAddModal('area')">â• Nueva Ãrea</button>
                    </div>

                    <div class="col-span-1">
                        <label class="small-muted mb-1 block">Responsable</label>
                        <select id="selectResp" class="w-full p-2 rounded bg-transparent border border-zinc-700"></select>
                    </div>
                    <div class="col-span-1 flex items-end gap-2">
                        <button type="button" class="px-3 py-2 bg-indigo-600 rounded btn" onclick="openAddModal('responsable')">â• Nuevo</button>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="small-muted block mb-1">Cantidad de niveles</label>
                        <input id="inputCantidadNiv" type="number" min="1" max="6" value="3" class="p-2 rounded bg-transparent border border-zinc-700" onchange="renderNivelInputs()">
                    </div>
                    <div>
                        <label class="small-muted block mb-1">% Avance inicial (solo admin)</label>
                        <input id="inputAvance" type="number" min="0" max="100" value="0" class="p-2 rounded bg-transparent border border-zinc-700">
                    </div>
                    <div>
                        <label class="small-muted block mb-1">Carpeta Drive</label>
                        <input id="inputDrive" type="url" placeholder="https://drive.google.com/..." class="p-2 rounded bg-transparent border border-zinc-700">
                    </div>
                </div>

                <div>
                    <label class="small-muted block mb-1">Metas por nivel (0â€“100) â€” Empiezan en Nivel 0</label>
                    <div id="nivelesInputs" class="grid gap-2"></div>
                </div>

                <div>
                    <label class="small-muted block mb-1">Imagen KPI (URL)</label>
                    <input id="inputImagen" type="url" placeholder="https://..." class="p-2 rounded bg-transparent border border-zinc-700">
                </div>

                <div class="flex gap-2 justify-end mt-2">
                    <button type="button" class="px-4 py-2 rounded bg-zinc-600 hover:bg-zinc-500" onclick="closeCreateModal()">Cancelar</button>
                    <button type="submit" class="px-4 py-2 rounded bg-emerald-500 hover:bg-emerald-400">Guardar tarea</button>
                </div>
            </form>
        </div>
    </div>

    <div id="addModal" class="fixed inset-0 hidden z-50 flex items-center justify-center">
        <div class="modal-overlay"></div>
        <div class="relative max-w-md w-full mx-4 modal-card rounded-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="addTitle" class="text-lg font-bold">â• Nuevo</h3>
                <button class="text-gray-300" onclick="closeAddModal()">âœ•</button>
            </div>
            <div class="grid gap-3">
                <input id="addInput" class="p-2 rounded bg-transparent border border-zinc-700" placeholder="Nombre...">
                <input id="addColor" class="p-2 rounded bg-transparent border border-zinc-700" placeholder="#HEX (opcional)">
                <div class="flex justify-end gap-2">
                    <button class="px-4 py-2 rounded bg-zinc-600" onclick="closeAddModal()">Cancelar</button>
                    <button class="px-4 py-2 rounded bg-indigo-600" onclick="saveAdd()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="detailModal" class="fixed inset-0 hidden z-50 flex items-center justify-center">
        <div class="modal-overlay"></div>
        <div class="relative max-w-3xl w-full mx-4 modal-card rounded-lg p-6">
            <div class="flex justify-between items-start gap-4">
                <div>
                    <h2 id="detailTitle" class="text-2xl font-bold"></h2>
                    <p class="small-muted" id="detailItem"></p>
                    <div id="detailAreas" class="mt-2"></div>
                </div>
                <div class="flex gap-2">
                    <button id="editSaveBtn" class="hidden px-3 py-1 rounded bg-emerald-500">Guardar cambios</button>
                    <button class="px-3 py-1 rounded bg-zinc-600" onclick="closeDetailModal()">Cerrar</button>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-4 mt-4">
                <div>
                    <p class="small-muted">Responsable</p>
                    <p id="detailResp" class="font-semibold"></p>

                    <p class="small-muted mt-3">Niveles de cumplimiento</p>
                    <ul id="detailNiveles" class="mt-2"></ul>

                    <p class="small-muted mt-3">% Avance</p>
                    <div class="flex items-center gap-3 mt-1">
                        <div class="w-full bg-zinc-800 h-4 rounded overflow-hidden">
                            <div id="detailProgressBar" class="h-4 bg-emerald-500" style="width:0%"></div>
                        </div>
                        <div id="avanceDisplay" class="font-semibold">0%</div>
                    </div>

                    <div id="avanceEditWrap" class="mt-2 hidden">
                        <label class="small-muted">Editar % Avance</label>
                        <input id="avanceEdit" type="number" min="0" max="100" class="p-2 mt-1 w-32 rounded bg-transparent border border-zinc-700">
                    </div>

                    <p class="small-muted mt-4">Carpeta Drive</p>
                    <a id="detailDrive" class="text-indigo-400 hover:underline" target="_blank" rel="noopener noreferrer">Abrir Carpeta</a>

                    <div class="mt-4">
                        <p class="small-muted">Comentarios</p>
                        <ul id="detailComentarios" class="mt-2 scroll-y"></ul>

                        <div class="flex gap-2 mt-2">
                            <input id="comentarioText" placeholder="Agregar comentario..." class="p-2 rounded bg-transparent border border-zinc-700 flex-1">
                            <button id="btnAddComment" class="px-3 py-2 rounded bg-indigo-600" onclick="addComment()">Comentar</button>
                        </div>
                    </div>
                </div>

                <div>
                    <p class="small-muted">Imagen KPI</p>
                    <div class="mt-2 card p-3 rounded">
                        <img id="detailImagen" src="" alt="Imagen KPI" class="w-full object-contain rounded" />
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
/* index.html UI glue: usa window.APP.* (serverless-based) que debes tener en /GALAXIA/app.js
Â  Â - FRONTEND_CONFIG debe existir (en /GALAXIA/frontend-config.js). */

(function(){
Â  // Safety checks
Â  if(typeof FRONTEND_CONFIG === 'undefined') {
Â  Â  alert('Falta frontend-config.js (FRONTEND_CONFIG). AÃ±Ã¡delo en /GALAXIA/frontend-config.js');
Â  Â  throw new Error('FRONTEND_CONFIG missing');
Â  }

Â  // Local state
Â  let admin = false;
Â  let tasks = [];
Â  let areas = [];
Â  let respons = [];
Â  let currentIndex = null;

Â  // Helpers
Â  function escapeHtml(s){ if(!s && s !== 0) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;'); }
Â  function formatPct(v){ if(v===null||v===undefined||v==='') return 'â€”'; return `${v}%`; }
Â  function compareItems(a,b){ if(!a) return 1; if(!b) return -1; const pa=(a+'').split('.').map(x=>parseInt(x)||0); const pb=(b+'').split('.').map(x=>parseInt(x)||0); for(let i=0;i<Math.max(pa.length,pb.length);i++){ if((pa[i]||0) < (pb[i]||0)) return -1; if((pa[i]||0) > (pb[i]||0)) return 1; } return 0; }
Â  function getAreaColorByName(name){ const f = areas.find(x=>x.nombre === name); return f ? f.color : '#6b7280'; }

Â  // Wait for window.APP to exist (timeout fallback)
Â  async function waitForApp(timeout = 5000){
Â  Â  if(window.APP) return;
Â  Â  return new Promise((resolve) => {
Â  Â  Â  const start = Date.now();
Â  Â  Â  const id = setInterval(()=> {
Â  Â  Â  Â  if(window.APP) { clearInterval(id); resolve(); }
Â  Â  Â  Â  if(Date.now() - start > timeout){ clearInterval(id); resolve(); }
Â  Â  Â  }, 150);
Â  Â  });
Â  }
Â  
Â  /* âš¡ OPTIMIZED SAVE FUNCTION âš¡ */
Â  // Centraliza la lÃ³gica de guardado de tareas y actualiza localmente
Â  async function saveTasksAndRefreshUI(newTaskArray = tasks, refreshTable = true, refreshDetail = false){
Â  Â  tasks = newTaskArray; // Actualiza la variable global con la versiÃ³n mÃ¡s reciente
Â  Â  try {
Â  Â  Â  if(window.APP && (typeof window.APP.saveTareas === 'function' || typeof window.APP.saveTasks === 'function')){
Â  Â  Â  Â  const saveFunc = window.APP.saveTareas || window.APP.saveTasks;
Â  Â  Â  Â  await saveFunc(tasks);
Â  Â  Â  } else {
Â  Â  Â  Â  // Sin funciÃ³n de guardado, solo persiste localmente (no es un problema aquÃ­, pero es buen feedback)
Â  Â  Â  Â  console.warn("No hay funciÃ³n de guardado (window.APP.saveTareas/saveTasks). Solo cambios locales.");
Â  Â  Â  }
Â  Â  Â  if (refreshTable) renderTable();
Â  Â  Â  if (refreshDetail && currentIndex !== null) openDetail(currentIndex, false); // Re-renderiza el detalle SIN recargar datos
Â  Â  Â  return true;
Â  Â  } catch(err){
Â  Â  Â  console.error('Error guardando tarea', err);
Â  Â  Â  alert('Error guardando tarea: ' + (err.message||err));
Â  Â  Â  return false;
Â  Â  }
Â  }


Â  // Load data via window.APP
Â  async function loadAll(){
Â  Â  await waitForApp();
Â  Â  let fetchedData = {};
Â  Â  
Â  Â  if(window.APP && typeof window.APP.loadAll === 'function'){
Â  Â  Â  try { fetchedData = await window.APP.loadAll() || {}; } catch(e){ console.warn('Error window.APP.loadAll', e); fetchedData = {}; }
Â  Â  }

Â  Â  // Fallback or merge with raw files
Â  Â  if(Object.keys(fetchedData).length === 0){
Â  Â  Â  const rawBase = FRONTEND_CONFIG.RAW_BASE || '';
Â  Â  Â  try {
Â  Â  Â  Â  const rT = await fetch(rawBase + (FRONTEND_CONFIG.FILES.tareas || 'tareas.json'));
Â  Â  Â  Â  fetchedData.tareas = rT.ok ? await rT.json() : [];
Â  Â  Â  } catch(e){ fetchedData.tareas = []; }
Â  Â  Â  try {
Â  Â  Â  Â  const rA = await fetch(rawBase + (FRONTEND_CONFIG.FILES.areas || 'areas.json'));
Â  Â  Â  Â  fetchedData.areas = rA.ok ? await rA.json() : [];
Â  Â  Â  } catch(e){ fetchedData.areas = []; }
Â  Â  Â  try {
Â  Â  Â  Â  const rR = await fetch(rawBase + (FRONTEND_CONFIG.FILES.responsables || 'responsables.json'));
Â  Â  Â  Â  fetchedData.respons = rR.ok ? await rR.json() : [];
Â  Â  Â  } catch(e){ fetchedData.respons = []; }
Â  Â  }

Â  Â  // normalize arrays if necessary
Â  Â  tasks = fetchedData.tareas && Array.isArray(fetchedData.tareas) ? fetchedData.tareas : (fetchedData.tareas && fetchedData.tareas.tareas) || [];
Â  Â  areas = fetchedData.areas && Array.isArray(fetchedData.areas) ? fetchedData.areas : (fetchedData.areas && fetchedData.areas.areas) || [];
Â  Â  respons = fetchedData.respons && Array.isArray(fetchedData.respons) ? fetchedData.respons : (fetchedData.respons && fetchedData.respons.responsables) || [];


Â  Â  renderAreasAndResps();
Â  Â  renderTable();
Â  }

Â  /* ğŸ§  CORE LOGIC: Nivel / Avance ğŸ§  */
Â  // Calcula el avance y asegura la coherencia de niveles cumplidos
Â  function calculateTaskProgress(task){
Â  Â  // 1. Encontrar el nivel mÃ¡s alto cumplido.
Â  Â  let highestCompletedLevelValue = 0;
Â  Â  (task.niveles || []).forEach(n => {
Â  Â  Â  if (n.cumplido && Number.isFinite(n.valor) && n.valor > highestCompletedLevelValue) {
Â  Â  Â  Â  highestCompletedLevelValue = n.valor;
Â  Â  Â  }
Â  Â  });

Â  Â  // 2. Si el avance manual (admin) es mayor al nivel mÃ¡s alto cumplido, respeta el avance manual.
Â  Â  if (task.avance > highestCompletedLevelValue) {
Â  Â  Â  // 3. Ajustar los niveles cumplidos para que coincidan con el avance manual (si es mayor)
Â  Â  Â  (task.niveles || []).forEach(n => {
Â  Â  Â  Â  // Si el avance es mayor o igual al valor del nivel, se considera cumplido
Â  Â  Â  Â  if (task.avance >= n.valor) {
Â  Â  Â  Â  Â  n.cumplido = true;
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  // Aseguramos que el avance estÃ© en el rango 0-100
Â  Â  Â  task.avance = Math.min(100, Math.max(0, task.avance));
Â  Â  Â  return task.avance; // Devuelve el avance manual
Â  Â  }

Â  Â  // 4. Si el avance manual es menor o igual al nivel mÃ¡s alto, se usa el valor del nivel cumplido.
Â  Â  task.avance = highestCompletedLevelValue;
Â  Â  return highestCompletedLevelValue;
Â  }
Â  
Â  /* ---------- Render UI ---------- */
Â  function renderAreasAndResps(){
Â  Â  const selA = document.getElementById('selectAreas'); if(selA){ selA.innerHTML = ''; areas.forEach(a=>{ const opt = document.createElement('option'); opt.value = a.nombre; opt.textContent = a.nombre; selA.appendChild(opt); }); }
Â  Â  const selR = document.getElementById('selectResp'); if(selR){ selR.innerHTML = ''; respons.forEach(r=>{ const opt = document.createElement('option'); opt.value = r; opt.textContent = r; selR.appendChild(opt); }); }
Â  Â  document.getElementById('countAreas').innerText = areas.length || 0;
Â  }

Â  function renderTable(){
Â  Â  // Recalcula el avance antes de renderizar la tabla para mantener la coherencia
Â  Â  const arr = [...tasks].map(t => { t.avance = calculateTaskProgress(t); return t; }).sort((x,y)=>compareItems(x.item,y.item));
Â  Â  
Â  Â  document.getElementById('countTasks').innerText = arr.length || 0;
Â  Â  if(arr.length === 0){
Â  Â  Â  document.getElementById('taskTable').innerHTML = `<div class="p-8 text-center small-muted">No hay tareas. ${ admin ? 'Crea una con â• Nueva tarea' : 'Pide a un administrador crear una tarea.' }</div>`;
Â  Â  Â  return;
Â  Â  }
Â  Â  let html = `<table class="w-full text-left"><thead>
Â  Â  Â  <tr class="text-zinc-400 text-sm">
Â  Â  Â  Â  <th class="p-3">Item</th>
Â  Â  Â  Â  <th class="p-3">TÃ­tulo</th>
Â  Â  Â  Â  <th class="p-3">Ãreas</th>
Â  Â  Â  Â  <th class="p-3">Responsable</th>
Â  Â  Â  Â  <th class="p-3">Niveles</th>
Â  Â  Â  Â  <th class="p-3">Carpeta</th>
Â  Â  Â  </tr></thead><tbody class="space-y-2">`;
Â  Â  arr.forEach(t => {
Â  Â  Â  const idx = tasks.findIndex(x => x.id === t.id); // Usamos ID para ser mÃ¡s robustos
Â  Â  Â  const areasHtml = (t.areas||[]).map(a => `<span class="tag" style="background:${getAreaColorByName(a)}">${escapeHtml(a)}</span>`).join(' ');
Â  Â  Â  const levelsHtml = (t.niveles||[]).map(n => {
Â  Â  Â  Â  const c = n.cumplido ? 'âœ…' : 'â¬œ';
Â  Â  Â  Â  return `<span class="level-badge">${c} N${n.nivel}: ${formatPct(n.valor)}</span>`;
Â  Â  Â  }).join(' ');
Â  Â  Â  html += `<tr class="row-hover" onclick="openDetail(${idx})">
Â  Â  Â  Â  <td class="p-3 align-top"><div class="font-semibold">${escapeHtml(t.item)}</div></td>
Â  Â  Â  Â  <td class="p-3 align-top"><div class="font-medium">${escapeHtml(t.titulo)}</div></td>
Â  Â  Â  Â  <td class="p-3 align-top">${areasHtml}</td>
Â  Â  Â  Â  <td class="p-3 align-top">${escapeHtml(t.responsable)}</td>
Â  Â  Â  Â  <td class="p-3 align-top">${levelsHtml}</td>
Â  Â  Â  Â  <td class="p-3 align-top"><a class="text-indigo-400 hover:underline" href="${escapeHtml(t.carpetaDrive||'#')}" target="_blank">ğŸ“‚ Abrir</a></td>
Â  Â  Â  </tr>`;
Â  Â  });
Â  Â  html += `</tbody></table>`;
Â  Â  document.getElementById('taskTable').innerHTML = html;
Â  }

Â  /* ---------- Create modal logic (niveles empiezan en 0) ---------- */
Â  function openCreateModal(){
Â  Â  if(!admin){ alert('Solo admin puede crear tareas. Inicia sesiÃ³n con el cÃ³digo.'); return; }
Â  Â  document.getElementById('createTitle').innerText = 'â• Nueva tarea';
Â  Â  document.getElementById('createForm').reset();
Â  Â  renderAreasAndResps();
Â  Â  renderNivelInputs();
Â  Â  document.getElementById('createModal').classList.remove('hidden');
Â  }
Â  function closeCreateModal(){ document.getElementById('createModal').classList.add('hidden'); }

Â  function renderNivelInputs(){
Â  Â  const cnt = document.getElementById('nivelesInputs'); cnt.innerHTML = '';
Â  Â  const how = parseInt(document.getElementById('inputCantidadNiv').value) || 1;
Â  Â  // now levels go from 0 to how-1
Â  Â  for(let i=0;i<how;i++){
Â  Â  Â  const wrap = document.createElement('div'); wrap.className='flex gap-2 items-center';
Â  Â  Â  const label = document.createElement('label'); label.textContent = `Nivel ${i}:`; label.className='small-muted w-24';
Â  Â  Â  const input = document.createElement('input'); input.type='number'; input.min=0; input.max=100; input.value= i===0 ? 0 : 25 + i * 15; // default values for clarity
Â  Â  Â  input.id=`meta_nivel_${i}`;
Â  Â  Â  input.className='p-2 rounded bg-transparent border border-zinc-700 w-32';
Â  Â  Â  const pct = document.createElement('span'); pct.className='small-muted'; pct.innerText = '%';
Â  Â  Â  input.addEventListener('input', ()=> {
Â  Â  Â  Â  let v = parseInt(input.value) || 0; if(v<0) v=0; if(v>100) v=100; input.value = v;
Â  Â  Â  });
Â  Â  Â  wrap.appendChild(label); wrap.appendChild(input); wrap.appendChild(pct);
Â  Â  Â  cnt.appendChild(wrap);
Â  Â  }
Â  }

Â  // create form submit
Â  document.getElementById('createForm').addEventListener('submit', async function(e){
Â  Â  e.preventDefault();
Â  Â  if(!admin){ alert('Solo admin puede crear tareas.'); return; }

Â  Â  const item = document.getElementById('inputItem').value.trim();
Â  Â  const titulo = document.getElementById('inputTitulo').value.trim();
Â  Â  const seleccion = Array.from(document.getElementById('selectAreas').selectedOptions).map(o=>o.value);
Â  Â  const responsable = document.getElementById('selectResp').value;
Â  Â  const cantidad = parseInt(document.getElementById('inputCantidadNiv').value) || 1;
Â  Â  const metas = [];
Â  Â  // levels start at 0
Â  Â  for(let i=0;i<cantidad;i++){
Â  Â  Â  const el = document.getElementById(`meta_nivel_${i}`);
Â  Â  Â  const val = parseInt((el || {value:0}).value) || 0;
Â  Â  Â  metas.push({ nivel: i, valor: val, cumplido: false });
Â  Â  }
Â  Â  let avance = parseInt(document.getElementById('inputAvance').value) || 0;
Â  Â  const carpetaDrive = document.getElementById('inputDrive').value.trim();
Â  Â  const imagenKpi = document.getElementById('inputImagen').value.trim();

Â  Â  if(!item || !titulo){ alert('Item y TÃ­tulo obligatorios'); return; }

Â  Â  const newTask = {
Â  Â  Â  id: Date.now(), // Usar un ID robusto
Â  Â  Â  item,
Â  Â  Â  titulo,
Â  Â  Â  areas: seleccion.length ? seleccion : ['Sin Ãrea'],
Â  Â  Â  responsable: responsable || 'Sin responsable',
Â  Â  Â  niveles: metas,
Â  Â  Â  avance,
Â  Â  Â  carpetaDrive,
Â  Â  Â  imagenKpi,
Â  Â  Â  comentarios: []
Â  Â  };
Â  Â  
Â  Â  // Calcula el avance inicial de la nueva tarea (ajusta niveles si es necesario)
Â  Â  calculateTaskProgress(newTask);

Â  Â  tasks.push(newTask);
Â  Â  
Â  Â  if (await saveTasksAndRefreshUI(tasks, true)) {
Â  Â  Â  closeCreateModal();
Â  Â  Â  alert('Tarea guardada âœ…');
Â  Â  }
Â  });

Â  /* ---------- Detail modal ---------- */
Â  // El parÃ¡metro skipRefreshData permite re-renderizar el modal sin hacer loadAll, evitando lentitud
Â  function openDetail(idx, skipRefreshData = true){
Â  Â  currentIndex = idx;
Â  Â  const t = tasks[idx];
Â  Â  if(!t) return;
Â  Â  
Â  Â  // âš¡ OptimizaciÃ³n: Recalcula y actualiza el avance localmente antes de mostrar el detalle
Â  Â  t.avance = calculateTaskProgress(t);
Â  Â  
Â  Â  document.getElementById('detailTitle').innerText = t.titulo;
Â  Â  document.getElementById('detailItem').innerText = `Item: ${t.item}`;
Â  Â  const areasWrap = document.getElementById('detailAreas'); areasWrap.innerHTML = '';
Â  Â  (t.areas||[]).forEach(a=>{
Â  Â  Â  const s = document.createElement('span'); s.className='tag'; s.style.background = getAreaColorByName(a); s.innerText = a;
Â  Â  Â  areasWrap.appendChild(s);
Â  Â  });

Â  Â  document.getElementById('detailResp').innerText = t.responsable || 'â€”';
Â  Â  const nivelesUL = document.getElementById('detailNiveles'); nivelesUL.innerHTML = '';
Â  Â  (t.niveles||[]).forEach((n,i)=>{
Â  Â  Â  const li = document.createElement('li'); li.className='flex items-center gap-3 py-1';
Â  Â  Â  const chk = document.createElement('input'); chk.type='checkbox'; chk.checked = !!n.cumplido; chk.disabled = !admin;
Â  Â  Â  chk.id = `detail_level_${t.id}_${i}`; // ID Ãºnico para el checkbox
Â  Â  Â  
Â  Â  Â  // âš¡ Fix: Guardado de Nivel y lÃ³gica de Avance
Â  Â  Â  chk.addEventListener('change', async ()=>{
Â  Â  Â  Â  if(!admin){ chk.checked = !chk.checked; alert('Solo admin puede cambiar niveles'); return; }
Â  Â  Â  Â  
Â  Â  Â  Â  n.cumplido = chk.checked; // âœ… El estado se guarda en el objeto t

Â  Â  Â  Â  // Recalcula el avance basado en el nuevo estado de niveles
Â  Â  Â  Â  t.avance = calculateTaskProgress(t);

Â  Â  Â  Â  if(await saveTasksAndRefreshUI(tasks, true, true)) { // Guarda y re-renderiza tabla y modal
Â  Â  Â  Â  Â  // updateDetailProgress(t) es llamado por openDetail(..., true)
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  // Si falla, revierte el estado
Â  Â  Â  Â  Â  n.cumplido = !chk.checked;
Â  Â  Â  Â  Â  chk.checked = !chk.checked;
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  
Â  Â  Â  const label = document.createElement('span'); label.innerHTML = `<strong>Nivel ${n.nivel}</strong> â€” ${formatPct(n.valor)}`;
Â  Â  Â  li.appendChild(chk); li.appendChild(label); nivelesUL.appendChild(li);
Â  Â  });

Â  Â  updateDetailProgress(t);
Â  Â  document.getElementById('avanceEditWrap').style.display = admin ? 'block' : 'none';
Â  Â  document.getElementById('avanceEdit').value = t.avance || 0;
Â  Â  document.getElementById('detailDrive').href = t.carpetaDrive || '#';
Â  Â  document.getElementById('detailDrive').innerText = t.carpetaDrive ? 'Abrir carpeta' : 'â€”';

Â  Â  renderComments(t);

Â  Â  const img = document.getElementById('detailImagen');
Â  Â  img.src = t.imagenKpi ? t.imagenKpi : 'https://via.placeholder.com/800x400.png?text=Sin+imagen';
Â  Â  img.alt = 'Imagen KPI';

Â  Â  document.getElementById('editSaveBtn').style.display = admin ? 'inline-block' : 'none';
Â  Â  document.getElementById('detailModal').classList.remove('hidden');

Â  Â  document.getElementById('editSaveBtn').onclick = async function(){
Â  Â  Â  if(!admin){ alert('Solo admin puede guardar cambios'); return; }
Â  Â  Â  
Â  Â  Â  const newAv = parseInt(document.getElementById('avanceEdit').value) || 0;
Â  Â  Â  t.avance = Math.min(100, Math.max(0, newAv));
Â  Â  Â  
Â  Â  Â  // Al editar el avance, llamamos a la lÃ³gica de coherencia
Â  Â  Â  calculateTaskProgress(t);
Â  Â  Â  
Â  Â  Â  if(await saveTasksAndRefreshUI(tasks, true, true)) {
Â  Â  Â  Â  alert('Cambios guardados âœ…');
Â  Â  Â  }
Â  Â  };
Â  }

Â  function closeDetailModal(){ currentIndex = null; document.getElementById('detailModal').classList.add('hidden'); }
Â  function updateDetailProgress(t){ 
Â  Â  const bar = document.getElementById('detailProgressBar'); 
Â  Â  const display = document.getElementById('avanceDisplay'); 
Â  Â  const value = t.avance || 0; 
Â  Â  bar.style.width = value + '%'; 
Â  Â  display.innerText = value + '%'; 
Â  Â  
Â  Â  // âš¡ Actualiza los checkboxes en el modal para reflejar el avance calculado
Â  Â  // Nota: Usamos querySelectorAll para encontrar los checkboxes correctos
Â  Â  const chks = document.querySelectorAll('#detailNiveles input[type="checkbox"]');
Â  Â  (t.niveles||[]).forEach((n,i) => {
Â  Â  Â  if(chks[i]) chks[i].checked = !!n.cumplido;
Â  Â  });
Â  }

Â  /* ---------- Comments ---------- */
Â  function renderComments(t){
Â  Â  const ul = document.getElementById('detailComentarios'); ul.innerHTML = '';
Â  Â  (t.comentarios||[]).slice().reverse().forEach(c=>{
Â  Â  Â  const li = document.createElement('li'); li.className='mb-2 p-2 bg-zinc-800 rounded';
Â  Â  Â  const ts = new Date(c.ts || Date.now()).toLocaleString();
Â  Â  Â  li.innerHTML = `<div class="small-muted text-xs">${escapeHtml(ts)}</div><div class="mt-1">${escapeHtml(c.text)}</div>`;
Â  Â  Â  ul.appendChild(li);
Â  Â  });
Â  }

Â  async function addComment(){
Â  Â  const txt = document.getElementById('comentarioText').value.trim();
Â  Â  if(!txt) return;
Â  Â  if(currentIndex === null) return;
Â  Â  const t = tasks[currentIndex];
Â  Â  t.comentarios = t.comentarios || [];
Â  Â  t.comentarios.push({ text: txt, ts: Date.now() });
Â  Â  
Â  Â  if (await saveTasksAndRefreshUI(tasks, false, false)) { // Solo guarda, NO recarga tabla ni modal completo
Â  Â  Â  document.getElementById('comentarioText').value = '';
Â  Â  Â  renderComments(t); // Solo re-renderiza la secciÃ³n de comentarios
Â  Â  }
Â  }

Â  /* ---------- Add Area / Responsable ---------- */
Â  let addMode = '';
Â  function openAddModal(mode){
Â  Â  if(!admin){ alert('Solo admin puede crear Ã¡reas/responsables.'); return; }
Â  Â  addMode = mode;
Â  Â  document.getElementById('addTitle').innerText = mode === 'area' ? 'â• Nueva Ãrea' : 'â• Nuevo Responsable';
Â  Â  document.getElementById('addInput').value = '';
Â  Â  document.getElementById('addColor').value = '';
Â  Â  document.getElementById('addModal').classList.remove('hidden');
Â  }
Â  function closeAddModal(){ document.getElementById('addModal').classList.add('hidden'); }

Â  function isHexColor(s){ return /^#([0-9A-F]{3}){1,2}$/i.test(s); }
Â  async function saveAdd(){
Â  Â  const value = (document.getElementById('addInput').value || '').trim();
Â  Â  const pick = (document.getElementById('addColor').value || '').trim();
Â  Â  if(!value) return alert('Ingrese nombre vÃ¡lido');
Â  Â  
Â  Â  let success = false;
Â  Â  
Â  Â  if(addMode === 'area'){
Â  Â  Â  const color = isHexColor(pick) ? pick : (function(){ const p = ['#06b6d4','#7c3aed','#ef4444','#f97316','#14b8a6','#0ea5e9','#a3e635','#f43f5e']; return p[Math.floor(Math.random()*p.length)]; })();
Â  Â  Â  if(!areas.find(x=>x.nombre===value)) areas.push({ nombre: value, color });
Â  Â  Â  try {
Â  Â  Â  Â  if(window.APP && typeof window.APP.saveAreas === 'function') await window.APP.saveAreas(areas);
Â  Â  Â  Â  renderAreasAndResps(); // Solo re-renderiza la selecciÃ³n
Â  Â  Â  Â  success = true;
Â  Â  Â  } catch(e){ console.error('saveAreas', e); alert('Error guardando Ã¡rea'); }
Â  Â  } else {
Â  Â  Â  if(!respons.includes(value)) respons.push(value);
Â  Â  Â  try {
Â  Â  Â  Â  if(window.APP && typeof window.APP.saveRespons === 'function') await window.APP.saveRespons(respons);
Â  Â  Â  Â  renderAreasAndResps(); // Solo re-renderiza la selecciÃ³n
Â  Â  Â  Â  success = true;
Â  Â  Â  } catch(e){ console.error('saveRespons', e); alert('Error guardando responsable'); }
Â  Â  }
Â  Â  
Â  Â  if (success) {
Â  Â  Â  closeAddModal(); 
Â  Â  Â  alert((addMode === 'area' ? 'Ãrea' : 'Responsable') + ' guardado âœ…');
Â  Â  }
Â  }

Â  /* ---------- Admin login ---------- */
Â  document.getElementById('loginBtn').addEventListener('click', () => {
Â  Â  if(admin && document.getElementById('loginBtn').innerText === 'Cerrar sesiÃ³n'){
Â  Â  Â  if(confirm('Â¿Cerrar sesiÃ³n de admin?')){
Â  Â  Â  Â  admin = false;
Â  Â  Â  Â  document.getElementById('adminBadge').classList.add('hidden');
Â  Â  Â  Â  document.getElementById('newTaskBtn').classList.add('hidden');
Â  Â  Â  Â  document.getElementById('statusAdmin').innerText = 'Usuario';
Â  Â  Â  Â  document.getElementById('loginBtn').innerText = 'ğŸ”‘ Ingresar Admin';
Â  Â  Â  Â  renderTable();
Â  Â  Â  }
Â  Â  Â  return;
Â  Â  }

Â  Â  const code = prompt('Ingrese cÃ³digo de administrador:');
Â  Â  if(code === 'william.oliva'){
Â  Â  Â  admin = true;
Â  Â  Â  document.getElementById('adminBadge').classList.remove('hidden');
Â  Â  Â  document.getElementById('newTaskBtn').classList.remove('hidden');
Â  Â  Â  document.getElementById('statusAdmin').innerText = 'ADMIN';
Â  Â  Â  document.getElementById('loginBtn').innerText = 'Cerrar sesiÃ³n';
Â  Â  Â  alert('Acceso concedido âœ…');
Â  Â  Â  renderTable();
Â  Â  } else if(code === null){
Â  Â  Â  // cancel
Â  Â  } else {
Â  Â  Â  alert('CÃ³digo incorrecto âŒ');
Â  Â  }
Â  });

Â  // map newTaskBtn
Â  document.getElementById('newTaskBtn').addEventListener('click', openCreateModal);

Â  // Expose global functions used in HTML
Â  window.openDetail = openDetail;
Â  window.openAddModal = openAddModal;
Â  window.openCreateModal = openCreateModal;
Â  window.closeCreateModal = closeCreateModal;
Â  window.closeAddModal = closeAddModal;
Â  window.closeDetailModal = closeDetailModal;
Â  window.saveAdd = saveAdd;
Â  window.addComment = addComment;
Â  window.renderNivelInputs = renderNivelInputs; 

Â  // Boot
Â  (async function boot(){
Â  Â  try {
Â  Â  Â  await loadAll();
Â  Â  Â  console.log('UI cargada y lista');
Â  Â  } catch(e){
Â  Â  Â  console.error('Boot error', e);
Â  Â  Â  alert('Error inicializando la app: ' + (e && e.message ? e.message : e));
Â  Â  }
Â  })();

})();
</script>
</body>
</html>
